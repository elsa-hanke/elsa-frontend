<template>
  <div class="arvioitavat-kokonaisuudet mb-4">
    <b-row align-h="between" align-v="center">
      <b-col sm="6" cols="auto">
        <elsa-button
          :to="{
            name: 'lisaa-arvioitavan-kokonaisuuden-kategoria'
          }"
          variant="primary"
          class="mb-2 mt-2 mr-3"
        >
          {{ $t('lisaa-kategoria') }}
        </elsa-button>
        <elsa-button
          :to="{
            name: 'lisaa-arvioitava-kokonaisuus'
          }"
          variant="primary"
          class="mb-2 mt-2"
        >
          {{ $t('lisaa-arvioitava-kokonaisuus') }}
        </elsa-button>
      </b-col>
      <b-col cols="5" xl="auto">
        <b-row align-v="center" class="voimassaolo">
          <b-col cols="auto">
            <span class="text-uppercase text-size-sm">{{ $t('voimassaolopvm') }}:</span>
          </b-col>
          <b-col cols="auto" md="5">
            <elsa-form-datepicker id="voimassaolo" v-model="voimassaolo"></elsa-form-datepicker>
          </b-col>
        </b-row>
      </b-col>
    </b-row>
    <b-row>
      <b-col>
        <div v-if="loading" class="text-center">
          <b-spinner variant="primary" :label="$t('ladataan')" />
        </div>
        <div v-else-if="rows === 0">
          <b-alert variant="dark" show>
            <font-awesome-icon icon="info-circle" fixed-width class="text-muted" />
            <span v-if="voimassaolo != null">
              {{ $t('ei-hakutuloksia') }}
            </span>
            <span v-else>
              {{ $t('ei-arvioitavia-kokonaisuuksia') }}
            </span>
          </b-alert>
        </div>
        <b-table
          v-else
          fixed
          :items="kategoriatSorted"
          :fields="fields"
          class="arvioitavat-kokonaisuudet-table"
          details-td-class="row-details"
          stacked="md"
        >
          <template #table-colgroup>
            <col span="1" width="10%" />
            <col span="1" width="45%" />
            <col span="1" width="27%" />
          </template>

          <template #cell(jarjestys)="data">
            {{ data.item.jarjestysnumero }}
          </template>

          <template #cell(nimi)="data">
            <b-link
              :to="{
                name: 'arvioitavan-kokonaisuuden-kategoria',
                params: { kategoriaId: data.item.id }
              }"
              class="task-type"
            >
              {{ data.item.nimi }}
            </b-link>
          </template>

          <template #row-details="row">
            <b-table
              :items="filteredKokonaisuudet(row.item.arvioitavatKokonaisuudet)"
              :fields="fields"
            >
              <template #table-colgroup>
                <col span="1" width="12%" />
                <col span="1" width="45%" />
                <col span="1" width="27%" />
              </template>

              <template #cell(nimi)="data">
                <b-link
                  :to="{
                    name: 'arvioitava-kokonaisuus',
                    params: { kokonaisuusId: data.item.id }
                  }"
                  class="task-type"
                >
                  {{ data.item.nimi }}
                </b-link>
              </template>

              <template #cell(voimassaolo)="data">
                {{ $date(data.item.voimassaoloAlkaa) }} -
                {{ data.item.voimassaoloLoppuu != null ? $date(data.item.voimassaoloLoppuu) : '' }}
              </template>
            </b-table>
          </template>
        </b-table>
      </b-col>
    </b-row>
  </div>
</template>

<script lang="ts">
  import { Component, Vue } from 'vue-property-decorator'

  import { getArvioitavatKokonaisuudet } from '@/api/tekninen-paakayttaja'
  import ElsaButton from '@/components/button/button.vue'
  import ElsaFormDatepicker from '@/components/datepicker/datepicker.vue'
  import ElsaFormGroup from '@/components/form-group/form-group.vue'
  import { ArvioitavaKokonaisuus, ArvioitavanKokonaisuudenKategoria } from '@/types'
  import { dateBetween } from '@/utils/date'
  import { sortByAsc } from '@/utils/sort'
  import { toastFail } from '@/utils/toast'

  @Component({
    components: {
      ElsaButton,
      ElsaFormDatepicker,
      ElsaFormGroup
    }
  })
  export default class ArvioitavatKokonaisuudet extends Vue {
    kategoriat: ArvioitavanKokonaisuudenKategoria[] = []

    voimassaolo: string | null = null

    loading = true

    fields = [
      {
        key: 'jarjestys',
        label: this.$t('jarjestys'),
        class: 'jarjestys'
      },
      {
        key: 'nimi',
        label: this.$t('nimi'),
        class: 'nimi'
      },
      {
        key: 'voimassaolo',
        label: this.$t('voimassaolo'),
        class: 'voimassaolo'
      }
    ]

    async mounted() {
      await this.fetchKategoriat()
      this.loading = false
    }

    async fetchKategoriat() {
      try {
        this.kategoriat = (
          await getArvioitavatKokonaisuudet(this.$route?.params?.erikoisalaId)
        ).data
      } catch (err) {
        toastFail(this, this.$t('arvioitavien-kokonaisuuksien-hakeminen-epaonnistui'))
        this.$router.replace({ name: 'opetussuunnitelmat' })
      }
    }

    get kategoriatSorted() {
      return this.kategoriat
        .map((k) => ({ ...k, _showDetails: 'true' }))
        .sort((a, b) => sortByAsc(a.jarjestysnumero, b.jarjestysnumero, true))
    }

    get rows() {
      return this.kategoriatSorted?.length ?? 0
    }

    filteredKokonaisuudet(kokonaisuudet: ArvioitavaKokonaisuus[]) {
      return kokonaisuudet
        .filter((k) =>
          dateBetween(
            this.voimassaolo ?? undefined,
            k.voimassaoloAlkaa,
            k.voimassaoloLoppuu ?? undefined
          )
        )
        .sort((a, b) => sortByAsc(a.nimi, b.nimi))
    }
  }
</script>

<style lang="scss" scoped>
  @import '~@/styles/variables';
  @import '~bootstrap/scss/mixins/breakpoints';

  .voimassaolo {
    justify-content: flex-end;

    @include media-breakpoint-down(sm) {
      justify-content: flex-start;
      margin-bottom: 1rem;
    }
  }

  ::v-deep .arvioitavat-kokonaisuudet-table {
    .row-details {
      padding: 0;
      table {
        margin: 0;

        border: none;
        thead,
        &tr {
          display: none;
        }
        td {
          word-wrap: break-all;
        }
      }
    }
    @include media-breakpoint-up(xl) {
      .actions {
        text-align: right;
      }
    }

    @include media-breakpoint-down(sm) {
      border-bottom: none;

      tr {
        padding: 0.375rem 0 0.375rem 0;
        border: $table-border-width solid $table-border-color;

        &.outer-table {
          margin-bottom: 0.75rem;
          border-radius: 0.25rem;
        }

        &.b-table-has-details {
          margin-bottom: 0;
          border-radius: 0.25rem 0.25rem 0 0;
        }

        &.b-table-details {
          border: none;
          padding: 0;
          margin-bottom: 0.75rem;
          :last-of-type {
            border-radius: 0 0 0.25rem 0.25rem;
          }

          table {
            margin: 0;

            tr {
              border-top: none;
              margin-top: 0;
              padding-top: 0;
              td {
                padding-top: 0.75rem;
                &.nimi,
                &.actions {
                  display: none;
                }
              }
            }
          }
        }
      }

      td {
        padding: 0.25rem 0 0.25rem 0.25rem;
        border: none;

        &.nimi {
          font-size: $h4-font-size;
          > div {
            width: 100% !important;
            padding: 0.25rem 0.375rem 0 0.375rem !important;
          }
          &::before {
            display: none;
          }
        }

        &.tyyppi,
        &.tila,
        &.pvm,
        &.actions {
          > div {
            &:empty {
              display: none !important;
            }
            padding: 0 0.375rem 0 0.375rem !important;
          }
          &::before {
            text-align: left !important;
            padding-left: 0.375rem !important;
            font-weight: 500 !important;
            width: 100% !important;
          }
          text-align: left;
        }
      }
    }
  }
</style>
